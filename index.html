<!DOCTYPE html>
<html lang="en">
<head>
  <title>Educator Geologic Map of Ice Age Trail</title>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Interactive educator-focused geologic map of the Ice Age Trail with glacial and bedrock features." />

  <!-- ArcGIS API -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.25/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.25/"></script>

  <style>
    :root{
      /* TRAIL BRAND / ACCENTS */
      --amber: #F0AA00;
      --amber-800:#b97f00;
      --cr-dash:#444444;

      /* POIs */
      --poi-main: #e1b46c;
      --poi-outline: rgba(14,17,22,0.7);

      /* UI SHELL */
      --ink-900:#0E1116;
      --ink-800:#151922;
      --ink-700:#1C2230;
      --ink-600:#242C3B;
      --ink-500:#2F384B;
      --text-100:#ECF2F8;
      --text-300:#C3CDD8;
      --text-500:#90A0B5;
      --glass: rgba(24,29,40,0.62);
      --glass-border: rgba(255,255,255,0.09);

      /* GEOLOGY PALETTE */
      --g-green1:#98A48E; --g-green2:#C0DA94; --g-green3:#B6D3AC; --g-green4:#99C18A;
      --g-blue1:#6C93BA; --g-blue2:#476686; --g-blue3:#95B9DC;
      --g-violet:#D2C8D6; --g-neutral1:#B8C1BC; --g-neutral2:#E6E6E6;
      --g-brown1:#AA9388; --g-rose:#C6B4B7; --g-cream1:#F3EDC8; --g-yellow1:#FFFFAB; --g-yellow2:#F9EA98;

      --tint: rgba(108,147,186,0.10);
    }

    html, body { height:100%; width:100%; margin:0; padding:0; }
    body { font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans";
           background: var(--ink-900); color: var(--text-100); }

      .mapShell { position: relative; }     

    /* Header */
    .header{
  position: absolute;           
  top: 16px; left: 16px;        
  right: auto;                  
  z-index: 5;                   
  display:flex; align-items:center; gap:12px;
  background: linear-gradient(180deg, rgba(34,41,56,0.85), rgba(24,29,40,0.78));
  border:1px solid var(--glass-border);
  backdrop-filter: blur(10px);
  padding:10px 14px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.25);
}
    .brand { display:flex; align-items:center; gap:10px; }
    .chip { width:14px; height:14px; border-radius:999px; background:var(--amber);
      box-shadow: 0 0 0 2px rgba(0,0,0,.25), 0 0 10px rgba(240,170,0,.6) inset; }
    .title { margin:0; font-size:15px; letter-spacing:.3px; color:var(--text-100); }
    .header p.tip { font-size: 12px; color: var(--text-500); margin: 0 0 0 12px; }

    /* Buttons */
    .btn { appearance:none; border:none; cursor:pointer;
      background:linear-gradient(180deg, #2E3A52, #253148);
      color:var(--text-100); padding:8px 12px; border-radius:10px; font-size:13px; font-weight:600;
      border:1px solid var(--glass-border); transition: transform .06s ease, box-shadow .2s ease, background .2s ease; }
    .btn:hover { box-shadow:0 6px 14px rgba(0,0,0,.25); }
    .btn:active { transform: translateY(1px); }
    .btn-accent { background: linear-gradient(180deg, #ff7a1a, #e75d00); color:#141414; border:1px solid rgba(0,0,0,.15); }
    .btn-accent:hover { box-shadow:0 6px 20px rgba(254, 80, 0, .35); }
    .btn-min { padding: 0 8px; line-height: 20px; height: 24px; border-radius: 8px; background: rgba(255,255,255,.06); color: var(--text-100); }

    /* Esri widgets theming tweaks */
    .esri-ui .esri-widget { background: var(--glass); color: var(--text-100); border:1px solid var(--glass-border); backdrop-filter: blur(8px); }
    .esri-popup__header { background: linear-gradient(180deg, var(--ink-700), var(--ink-800)); }
    .esri-popup__content { background: linear-gradient(180deg, rgba(108,147,186,.08), rgba(24,29,40,.35)); }
    .esri-layer-list__item-label, .esri-search__input { color: var(--text-100); }
    .esri-widget__heading { color: var(--text-300) !important; }

    /* LayerList dark fix */
    .esri-layer-list, .esri-layer-list__list, .esri-layer-list__item, .esri-layer-list__item-label {
      background-color: var(--glass) !important; color: var(--text-100) !important;
    }
    .esri-layer-list__item-actions-menu, .esri-layer-list__item-actions-list, .esri-layer-list__item-actions-button {
      background-color: var(--ink-800) !important; color: var(--text-100) !important; border-color: var(--glass-border) !important;
    }
    .esri-layer-list__item:hover { background-color: rgba(255,255,255,0.06) !important; }

    /* Keep default widgets below header */
    .esri-ui-top-left { top: 90px !important; }

    /* ---------- App layout: map + right educator sidebar ---------- */
    .app{
      position: fixed; inset: 0;
      display: grid; grid-template-columns: 1fr 360px; grid-template-rows: 1fr;
      transition: grid-template-columns .24s ease;
    }
    .app.collapsed{ grid-template-columns: 1fr 0px; }

    #viewDiv { width: 100%; height: 100%; }

    .eduSide{
      background: var(--glass); border-left: 1px solid var(--glass-border);
      color: var(--text-100); backdrop-filter: blur(10px);
      box-shadow: 0 0 30px rgba(0,0,0,.25);
      overflow: hidden; display: flex; flex-direction: column;
    }
    .eduSide__head{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; background: linear-gradient(180deg, rgba(34,41,56,.9), rgba(24,29,40,.85));
      border-bottom: 1px solid var(--glass-border);
    }
    .eduSide__head h2{ margin:0; font-size:14px; letter-spacing:.08em; text-transform:uppercase; color:var(--text-300); }
    .eduSide__body{ padding:12px 14px; overflow:auto; }
    .eduSide__body h3{ margin:10px 0 6px; font-size:12px; color:var(--text-300); text-transform:uppercase; letter-spacing:.10em; }

    .eduTabs{
      display:flex;
      gap:6px;
      margin:4px 0 10px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      padding-bottom:4px;
    }
    .eduTabBtn{
      appearance:none;
      border:none;
      cursor:pointer;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.04);
      color:var(--text-300);
      transition:background .15s ease, color .15s ease;
    }
    .eduTabBtn.is-active{
      background:var(--amber);
      color:#111;
    }
    .eduTabPanel{ display:block; }
    .eduTabPanel[hidden]{ display:none; }
    .eduSide__body h4{
      margin:8px 0 4px;
      font-size:12px;
      color:var(--text-300);
      text-transform:uppercase;
      letter-spacing:.10em;
    }

    .pdfList, .promptList { margin: 6px 0 12px; padding-left: 0; list-style: none; }
    .pdfList li, .promptList li { margin: 6px 0; line-height: 1.35; }
    .pdfList a { display:inline-flex; align-items:center; gap:8px; text-decoration:none; color:var(--text-100);
      padding:6px 8px; border-radius:8px; transition: background .15s ease; }
    .pdfList a::before { content:"üìÑ"; font-size:16px; opacity:.9; }
    .pdfList a:hover { background: rgba(255,255,255,.06); text-decoration: underline; }

    /* Modal (always show on load until closed) */
    .modal{ position: fixed; z-index: 100; inset: 0; background: rgba(0,0,0,.5); }
    .modal[hidden]{ display: none !important; }
    .modal-content {
      width: min(820px, 92%); margin: 6% auto; border-radius: 18px; padding: 0; overflow: hidden;
      background: linear-gradient(180deg, #101520, #0c1019);
      border: 1px solid var(--glass-border); box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .modal-head { display:flex; align-items:center; gap:10px; padding:12px 16px;
      background: linear-gradient(180deg, rgba(34,41,56,.9), rgba(24,29,40,.85)); border-bottom:1px solid var(--glass-border); }
    .modal-head h2 { margin:0; font-size:18px; color:var(--text-100); }
    .modal .close { margin-left:auto; cursor:pointer; color:var(--text-300); font-size:20px; font-weight:700; background: rgba(255,255,255,.06);
      width:28px; height:28px; line-height:26px; text-align:center; border-radius:8px; }
    .modal .close:hover{ color:#fff; }
    .modal-body { display:grid; grid-template-columns: 140px 1fr; gap:16px; padding:16px; }
    .modal-body img { border-radius:10px; width:110px; height:auto; margin:6px auto 0; display:block; }
    .modal-text{ color:var(--text-300); }
    .modal-text ul { margin:10px 0 0 18px; }

    @media (max-width: 800px){
      .app{ grid-template-columns: 1fr; }
      .eduSide{ position:absolute; right:0; top:0; bottom:0; width:min(92vw, 360px); }
      .app.collapsed .eduSide{ display:none; }
    }
    @media (max-width: 640px){
      .modal-body { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <!-- App layout: Map + Right Sidebar -->
<div class="app" id="appRoot">
  <div class="mapShell">
    <div id="viewDiv" role="main" aria-label="Map"></div>

    <!-- Header (now confined to the map area) -->
    <div class="header" role="banner">
      <div class="brand">
        <span class="chip" aria-hidden="true"></span>
        <h1 class="title">Educator Geologic Map of the Ice Age Trail</h1>
      </div>
      <p class="tip">Click orange dots to open educator guides for that stop.</p>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button id="focusBtn" class="btn" title="Toggle Focus: highlight Trail & POIs">Focus Trail</button>
        <button id="eduBtn" class="btn btn-accent" type="button" aria-label="Educator Resources" title="Educator Resources">Educator Resources</button>
      </div>
    </div>
  </div>

  <aside id="eduSide" class="eduSide" aria-labelledby="eduSideTitle">
  <div class="eduSide__head">
    <h2 id="eduSideTitle">For Teachers</h2>
    <button id="eduToggle" class="btn btn-min" aria-expanded="true" aria-controls="eduSide">Hide</button>
  </div>

    <div class="eduSide__body">
    <!-- Tab buttons -->
    <div class="eduTabs" role="tablist" aria-label="Teacher content sections">
      <button class="eduTabBtn is-active" data-edutab="segments" role="tab" aria-selected="true">
        Segments
      </button>
      <button class="eduTabBtn" data-edutab="concepts" role="tab" aria-selected="false">
        Geologic Concepts
      </button>
      <button class="eduTabBtn" data-edutab="activities" role="tab" aria-selected="false">
        Activities
      </button>
    </div>

    <!-- SEGMENTS TAB PANEL -->
    <section id="eduTab-segments" class="eduTabPanel is-active" role="tabpanel" aria-label="Trail segments">
      <h3>Trail Segment</h3>
      <p id="segIntro">Click any Ice Age Trail segment on the map to see teacher information for that segment.</p>

      <div id="segDetails" hidden>
        <h3 id="segTitleLabel">Segment: <span id="segTitleText"></span></h3>

        <h4>Overview</h4>
        <div id="segOverview"></div>

        <h4>Bedrock Geology</h4>
        <div id="segBedrock"></div>

        <h4>Glacial Geology</h4>
        <div id="segGlacial"></div>

        <h4>Points of Interest Along This Segment</h4>
        <div id="segPOIs"></div>

        <h4>Linked Concepts</h4>
        <div id="segConceptsLinks"></div>

        <h4>Suggested Activities</h4>
        <div id="segActivitiesLinks"></div>
      </div>
    </section>

    <!-- CONCEPTS TAB PANEL -->
    <section id="eduTab-concepts" class="eduTabPanel" role="tabpanel" aria-label="Geologic concepts" hidden>
      <h3>Why this map exists</h3>
      <p>This educator-focused map helps Wisconsin teachers connect students to local geology along the Ice Age Trail. It‚Äôs designed for quick prep and print-friendly guides.</p>

      <h3>Saunters Program</h3>
      <ul class="pdfList">
        <li><a href="https://www.iceagetrail.org/saunters/" target="_blank" rel="noopener">Ice Age Trail Alliance: Saunters</a></li>
        <li><a href="https://storymaps.arcgis.com/stories/e039100982854c0db10e697349beec10" target="_blank" rel="noopener">Saunters StoryMap</a></li>
      </ul>

      <h3>How to use this map</h3>
      <ul class="promptList">
        <li>Pick a nearby segment or POI (orange dot).</li>
        <li>Open the popup to preview field features and download the printable guide.</li>
        <li>Use <em>Classroom Prep</em> prompts before the visit and <em>Sense-making</em> prompts after.</li>
      </ul>

      <h3>Standards alignment (quick look)</h3>
      <p>Activities align with WI Science (ESS2.A, ESS2.C, ESS3.B) and Environmental Literacy &amp; Sustainability (EES2‚ÄìEES4). Each printable lists specific codes/grade bands.</p>

      <h3>Printable teacher guides (examples)</h3>
      <ul class="pdfList" id="teacherGuideList">
        <li><a href="docs/How_Do_Moraines_Form.pdf" target="_blank" rel="noopener">How Do Moraines Form?</a></li>
        <li><a href="docs/How_Do_Drumlins_Form.pdf" target="_blank" rel="noopener">How Do Drumlins Form?</a></li>
        <li><a href="docs/What_Are_Eskers.pdf" target="_blank" rel="noopener">What Are Eskers?</a></li>
        <li><a href="docs/What_Are_Kettles_and_Kettle_Lakes.pdf" target="_blank" rel="noopener">What Are Kettles and Kettle Lakes?</a></li>
        <li><a href="docs/How_Glaciers_Shape_the_Land.pdf" target="_blank" rel="noopener">How Glaciers Shape the Land</a></li>
      </ul>
    </section>

    <!-- ACTIVITIES TAB PANEL -->
    <section id="eduTab-activities" class="eduTabPanel" role="tabpanel" aria-label="Activities" hidden>
      <h3>Classroom &amp; Trail Activities</h3>
      <p>Use these short activities to introduce or reinforce glacial and bedrock concepts in class or on the trail.</p>

      <div id="activitiesList">
        <!-- We'll populate this from JS; for now a couple of examples -->
        <h4>Blanket Moraine Demo (10 min)</h4>
        <p>Use a blanket and books to model how glaciers push rock into moraines. Works well before visiting any segment with moraines or hummocky topography.</p>

        <h4>Buried Ice &amp; Kettles Model (15‚Äì20 min)</h4>
        <p>Use ice cubes and sand in a clear container to illustrate how melting buried ice forms kettles and pitted outwash. Pairs nicely with Iola Ski Hill and other kettle-rich segments.</p>
      </div>
    </section>
  </div>
</aside>
</div>
 

  <!-- Welcome modal (always shows on load; closes when actioned) -->
  <div id="introModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcomeTitle">
    <div class="modal-content">
      <div class="modal-head">
        <h2 id="welcomeTitle">Welcome, Educators!</h2>
        <button class="close" aria-label="Close">&times;</button>
      </div>
      <div class="modal-body">
        <img src="LOGO_Ice-Age-Trail-Alliance-JPG-1267x1536.jpg" alt="Ice Age Trail Alliance Logo" />
        <div class="modal-text">
          <p>This interactive map highlights <b>bedrock</b> and <b>glacial features</b> along Wisconsin‚Äôs Ice Age Trail. Explore POIs, download printable teacher guides, and connect with the Saunters program.</p>
          <ul>
            <li><strong>Focus Mode:</strong> dim geology to spotlight Trail &amp; POIs.</li>
            <li><strong>Layers:</strong> open the layer list (bottom-right) to toggle content.</li>
          </ul>
          <div style="margin-top:12px; display:flex; gap:8px;">
            <button id="introExplore" class="btn btn-accent">Explore the Map</button>
            <button id="introTeachers" class="btn">For Teachers</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- API key -->
  <script src="config.local.js"></script>

  <script>
  require([
    "esri/config",
    "esri/Map",
    "esri/views/MapView",
    "esri/widgets/BasemapGallery",
    "esri/widgets/Locate",
    "esri/widgets/Search",
    "esri/widgets/Expand",
    "esri/layers/FeatureLayer",
    "esri/widgets/LayerList"
  ], function(esriConfig, Map, MapView, BasemapGallery, Locate, Search, Expand, FeatureLayer, LayerList) {

    if (!window.ARCGIS_API_KEY) console.error("ArcGIS API key is missing. Did you create config.local.js with your key?");
    esriConfig.apiKey = window.ARCGIS_API_KEY;

    // Map & View
    const map = new Map({ basemap: "gray-vector" });
    const view = new MapView({
      container: "viewDiv",
      map,
      center: [-89.8505, 44.8505],
      zoom: 8,
      highlightOptions: { color: [240,170,0,0.9], haloOpacity: 0.25, fillOpacity: 0.15 }
    });

    // Widgets
    const bgGallery = new BasemapGallery({ view });
    view.ui.add(new Expand({ view, content: bgGallery, expandIconClass: "esri-icon-basemap" }), "top-left");
    view.ui.add(new Locate({ view }), "top-left");
    const searchWidget = new Search({ view, suggestionsEnabled: true, maxSuggestions: 3 });
    view.ui.add(new Expand({ view, content: searchWidget, expandIconClass: "esri-icon-search", expandTooltip: "Search" }), { position: "top-left", index: 2 });

    // Layers
    const bedrockGeology = new FeatureLayer({
      url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/Bedrock_All_symbolized/FeatureServer",
      title: "Bedrock Geology",
      outFields: ["UnitName", "Age", "RockType", "Descr"],
      opacity: 0.65, blendMode: "multiply",
      popupTemplate: {
        title: "{UnitName}",
        content: `<b>Age:</b> {Age}<br><b>Rock Type:</b> {RockType}<br><b>Description:</b> {Descr}`
      }
    });
    map.add(bedrockGeology);

    const glacialGeology = new FeatureLayer({
      url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/Surficial_Geology_View/FeatureServer/0",
      title: "Glacial Geology",
      outFields: ["*"], opacity: 0.85, blendMode: "multiply",
      renderer: {
        type: "unique-value", field: "MapUnit",
        defaultSymbol: { type: "simple-fill", color: [200,200,200,0.15], outline: { color: [120,120,120,0.45], width: 0.3 } },
        uniqueValueInfos: [
          { value: "Ch", symbol: f("#98A48E") }, { value: "Ci", symbol: f("#C0DA94") },
          { value: "Cl", symbol: f("#98A48E") }, { value: "Cr", symbol: f("#B6D3AC") },
          { value: "Cs", symbol: f("#99C18A") }, { value: "Hh", symbol: f("#6C93BA") },
          { value: "Hm", symbol: f("#476686") }, { value: "Hs", symbol: f("#95B9DC") },
          { value: "Mr", symbol: f("#D2C8D6") }, { value: "b",  symbol: f("#B8C1BC") },
          { value: "lp", symbol: f("#E6E6E6") }, { value: "o",  symbol: f("#AA9388") },
          { value: "ru", symbol: f("#C6B4B7") }, { value: "sc", symbol: f("#F3EDC8") },
          { value: "sm", symbol: f("#F3EDC8") }, { value: "sn", symbol: f("#FFFFAB") },
          { value: "st", symbol: f("#F9EA98") }, { value: "su", symbol: f("#F3EDC8") }
        ]
      },
      popupTemplate: { title: "{Simplified}", content: "<b>Age:</b> {Age}<br><b>Description:</b> {Simplifi_1}" }
    });
    map.add(glacialGeology);

    function f(hex){
      const rgb = hexToRgb(hex);
      return { type: "simple-fill", color: [rgb.r, rgb.g, rgb.b, 0.9], outline: { color: [60,60,60,0.55], width: 0.4 } };
    }
    function hexToRgb(hex){ const h = hex.replace("#",""); return { r: parseInt(h.slice(0,2),16), g: parseInt(h.slice(2,4),16), b: parseInt(h.slice(4,6),16) }; }

    const poiLayer = new FeatureLayer({
      url: "https://services1.arcgis.com/kkX9mRo34fTGAX96/arcgis/rest/services/POIs/FeatureServer/0",
      title: "Geologic Points of Interest",
      outFields: ["*"],
      renderer: {
        type: "simple",
        symbol: {
          type: "simple-marker", style: "circle", size: 11,
          color: getComputedStyle(document.documentElement).getPropertyValue('--poi-main').trim(),
          outline: { color: getComputedStyle(document.documentElement).getPropertyValue('--poi-outline').trim(), width: 1.2 }
        }
      },
      popupTemplate: {
        title: "{Name}",
        content: (e) => {
          const a = e.graphic.attributes || {};
          const has = v => v && String(v).trim() !== "";
          return `
            <div style="line-height:1.45">
              ${has(a.Feature_Type) ? `<div><b>Type:</b> ${a.Feature_Type}</div>` : ""}
              ${has(a.Description)  ? `<div style="margin-top:8px;">${a.Description}</div>` : ""}
            </div>`;
        }
      }
    });
    map.add(poiLayer);

    const trailURL = "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT_Segments_CR/FeatureServer/0";
    const sectionsHalo = new FeatureLayer({
      url: trailURL, title: "IAT (halo)", listMode: "hide",
      outFields: ["Segment","length_mi","Status"],
      renderer: {
        type: "unique-value", field: "Status",
        defaultSymbol: { type: "simple-line", color: [0,0,0,0.22], width: 6.0 },
        uniqueValueInfos: [
          { value: "Ice Age Trail", symbol: { type:"simple-line", color:[0,0,0,0.25], width: 6.2 } },
          { value: "Connecting Route", symbol: { type:"simple-line", color:[0,0,0,0.20], width: 5.8, style:"dash" } }
        ]
      }
    });
    const sectionsTop = new FeatureLayer({
      url: trailURL, title: "IAT Sections & Connecting Routes",
      outFields: ["Segment","length_mi","Status"],
      renderer: {
        type: "unique-value", field: "Status",
        defaultSymbol: { type: "simple-line", color: [240,170,0,1], width: 2.8 },
        uniqueValueInfos: [
          { value: "Ice Age Trail", symbol: { type:"simple-line", color:[240,170,0,1], width: 2.8 } },
          { value: "Connecting Route", symbol: { type:"simple-line", color:[68,68,68,1], width: 2.6, style:"dash" } }
        ]
      },
      popupTemplate: { title: "{Segment}", content: `<div style="margin-bottom:8px;"><b>Type:</b> {Status}</div><div><b>Length (mi):</b> {length_mi}</div>` }
    });
    map.addMany([sectionsHalo, sectionsTop]);

    const parking = new FeatureLayer({
      url: "https://services.arcgis.com/EeCmkqXss9GYEKIZ/arcgis/rest/services/IAT_Parking/FeatureServer",
      title: "Parking Areas",
      outFields: ["Parking_Type","Description","Fee","Overnight_Park","Parking_Notes"],
      popupTemplate: {
        title: "Parking Area",
        content: `<div style="margin-bottom:6px;"><b>Type:</b> {Parking_Type}</div>
                  <div style="margin-bottom:6px;"><b>Description:</b> {Description}</div>
                  <div style="margin-bottom:6px;"><b>Fee:</b> {Fee}</div>
                  <div style="margin-bottom:6px;"><b>Overnight:</b> {Overnight_Park}</div>
                  <div><b>Notes:</b> {Parking_Notes}</div>`
      }
    });
    map.add(parking);

    // ----- Educator Sidebar: toggle + view.padding sync -----
    const appRoot   = document.getElementById("appRoot");
    const eduSide   = document.getElementById("eduSide");
    const eduToggle = document.getElementById("eduToggle");
    const headerEduBtn = document.getElementById("eduBtn");

    // ----- Teacher Panel Tabs (Segments | Concepts | Activities) -----
    const tabButtons = document.querySelectorAll(".eduTabBtn");
    const tabPanels  = document.querySelectorAll(".eduTabPanel");

    function setActiveTab(name){
      tabButtons.forEach(btn => {
        const isActive = btn.dataset.edutab === name;
        btn.classList.toggle("is-active", isActive);
        btn.setAttribute("aria-selected", String(isActive));
      });
      tabPanels.forEach(panel => {
        const isMatch = panel.id === `eduTab-${name}`;
        panel.hidden = !isMatch;
      });
    }

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const name = btn.dataset.edutab;
        setActiveTab(name);
      });
    });

     // ----- Segment content (start with Iola Ski Hill Segment) -----
    const segmentContent = {
      "New Hope": {
        overview: `
          <p>The Iola Ski Hill segment sits where ancient granite bedrock meets
          young glacial deposits. It‚Äôs an excellent place to show students how
          very old rocks and very recent glacial processes work together to shape
          Wisconsin‚Äôs hills and valleys.</p>
        `,
        bedrock: `
          <p><strong>Wolf River Granite</strong> and <strong>Red River Adamellite</strong>
          form the ‚Äúbasement rock‚Äù beneath this segment. These Middle Proterozoic
          intrusive rocks are about 1.5 billion years old, cooled slowly from magma
          deep underground, and now support the glacial hills above.</p>
          <p><em>Kid version:</em> These hills sit on extremely old granite that formed
          like fudge cooling deep inside the Earth‚Äîlong before dinosaurs existed.</p>
        `,
        glacial: `
          <p>Late Pleistocene glaciers covered this area, leaving behind
          <strong>morainal glacial sediment (Holy Hill Formation)</strong> and
          <strong>collapsed meltwater-stream sediment</strong>. As the ice paused,
          it built ridges of sandy till. Where meltwater streams flowed over buried ice
          and that ice later melted, the ground sagged into hummocky, pitted terrain.</p>
          <p><em>Kid version:</em> A giant glacier dropped piles of sand and rocks and
          left lumpy hills and bowl-shaped holes when buried ice chunks melted.</p>
        `,
        pois: `
          <ul>
            <li><strong>Pitted Outwash</strong> ‚Äì Sandy plain with scattered pits where
            buried ice melted and the ground collapsed into kettles.</li>
            <li><strong>New Hope‚ÄìIola ‚Äì Ice-Walled Lake Plain #1</strong> ‚Äì Flat-topped
            ridge that was once the muddy bottom of a lake held inside walls of ice.</li>
            <li><strong>New Hope‚ÄìIola ‚Äì Scenic Overlook</strong> ‚Äì High vantage point for
            viewing the hummock‚Äìkettle terrain and discussing glacial landscapes.</li>
            <li><strong>New Hope‚ÄìIola ‚Äì Hummock Field #1</strong> ‚Äì Cluster of lumpy hills
            formed as debris-covered ice melted in place.</li>
          </ul>
        `,
        conceptsHtml: `
          <p>This segment pairs well with lessons on:</p>
          <ul>
            <li>Moraines and glacial till</li>
            <li>Pitted outwash and kettles</li>
            <li>Ice-walled lake plains</li>
            <li>Hummocky topography from melting buried ice</li>
            <li>Intrusive igneous rocks (granite) and the Wolf River Batholith</li>
          </ul>
        `,
        activitiesHtml: `
          <ul>
            <li><strong>Blanket Moraine Demo (10 min):</strong> Use a blanket and books to
            model how glaciers push material into moraines.</li>
            <li><strong>Buried Ice &amp; Kettles Model (15‚Äì20 min):</strong> Use ice cubes
            and sand in a clear container to show how melting buried ice forms kettles.</li>
            <li><strong>Overlook Landscape Sketch (20‚Äì30 min):</strong> Sketch the
            hummock‚Äìkettle terrain from the scenic overlook and label likely glacial features.</li>
          </ul>
        `
      }
      // Add more segments here later as needed
    };

    const segIntroEl      = document.getElementById("segIntro");
    const segDetailsEl    = document.getElementById("segDetails");
    const segTitleTextEl  = document.getElementById("segTitleText");
    const segOverviewEl   = document.getElementById("segOverview");
    const segBedrockEl    = document.getElementById("segBedrock");
    const segGlacialEl    = document.getElementById("segGlacial");
    const segPOIsEl       = document.getElementById("segPOIs");
    const segConceptsEl   = document.getElementById("segConceptsLinks");
    const segActivitiesEl = document.getElementById("segActivitiesLinks");

    function updateSegmentPanel(segmentName){
      const data = segmentContent[segmentName];
      setActiveTab("segments");
      if (!data){
        segIntroEl.textContent = `No custom educator content is available yet for "${segmentName}".`;
        segDetailsEl.hidden = true;
        return;
      }
      segIntroEl.textContent = "";
      segDetailsEl.hidden = false;
      segTitleTextEl.textContent = segmentName;
      segOverviewEl.innerHTML   = data.overview;
      segBedrockEl.innerHTML    = data.bedrock;
      segGlacialEl.innerHTML    = data.glacial;
      segPOIsEl.innerHTML       = data.pois;
      segConceptsEl.innerHTML   = data.conceptsHtml;
      segActivitiesEl.innerHTML = data.activitiesHtml;
    }

    function syncPadding(){
      const collapsed = appRoot.classList.contains("collapsed");
      const sideWidth = collapsed ? 0 : eduSide.getBoundingClientRect().width;
      view.padding = { top: 0, left: 0, bottom: 0, right: sideWidth };
    }
    syncPadding();

    eduToggle.addEventListener("click", () => {
      const collapsed = appRoot.classList.toggle("collapsed");
      eduToggle.setAttribute("aria-expanded", String(!collapsed));
      eduToggle.textContent = collapsed ? "Show" : "Hide";
      syncPadding();
    });

    headerEduBtn.addEventListener("click", () => {
      if (appRoot.classList.contains("collapsed")){
        appRoot.classList.remove("collapsed");
        eduToggle.setAttribute("aria-expanded", "true");
        eduToggle.textContent = "Hide";
        syncPadding();
      } else {
        // If already open, scroll to top for convenience
        eduSide.querySelector('.eduSide__body')?.scrollTo({ top: 0, behavior: 'smooth' });
      }
    });

    const ro = new ResizeObserver(syncPadding);
    ro.observe(eduSide);
    window.addEventListener("resize", syncPadding);

    // ----- Welcome Modal (always show; close actions) -----
    const introModal    = document.getElementById("introModal");
    const introCloseBtn = introModal.querySelector(".close");
    const introExplore  = document.getElementById("introExplore");
    const introTeachers = document.getElementById("introTeachers");

    // show on load
    introModal.hidden = false;
    setTimeout(() => introExplore?.focus(), 50);

    function closeIntro(){ introModal.hidden = true; }
    introCloseBtn.addEventListener("click", closeIntro);
    introExplore.addEventListener("click", closeIntro);
    introTeachers.addEventListener("click", () => { closeIntro(); appRoot.classList.remove("collapsed"); eduToggle.setAttribute("aria-expanded","true"); eduToggle.textContent="Hide"; syncPadding(); });
    introModal.addEventListener("click", (e) => { if (e.target === introModal) closeIntro(); });
    document.addEventListener("keydown", (e) => { if (e.key === "Escape" && !introModal.hidden) closeIntro(); });

    // ----- Layer List -----
    const layerList = new LayerList({ view });
const layerListExpand = new Expand({
  view,
  content: layerList,
  expandIconClass: "esri-icon-layer-list",
  expandTooltip: "Layers",
  expanded: false
});

// Add it to the top-left position, index ensures it sits just below Search/Locate
view.ui.add(layerListExpand, { position: "top-left", index: 3 });

    // ----- Focus Mode -----
    let focusOn = false;
    const ORIGINALS = {
      glacialOpacity: glacialGeology.opacity,
      bedrockOpacity: bedrockGeology.opacity,
      poiSize: (poiLayer.renderer?.symbol && Number(poiLayer.renderer.symbol.size)) || 12,
      trailWidthIAT: 2.8, trailWidthCR: 2.6
    };
    const focusBtn = document.getElementById("focusBtn");
    focusBtn.addEventListener("click", () => {
      focusOn = !focusOn;
      focusBtn.textContent = focusOn ? "Show Full Geology" : "Focus Trail";
      if (focusOn) {
        glacialGeology.opacity = 0.25;
        bedrockGeology.opacity  = 0.18;
        const poiR = poiLayer.renderer.clone(); poiR.symbol.size = ORIGINALS.poiSize + 4; poiLayer.renderer = poiR;
        const r = sectionsTop.renderer.clone();
        r.uniqueValueInfos = r.uniqueValueInfos.map((u) => {
          const sym = u.symbol.clone();
          sym.width = (u.value === "Connecting Route") ? 3.2 : 3.6;
          if (u.value === "Connecting Route") sym.style = "dash";
          return { ...u, symbol: sym };
        });
        sectionsTop.renderer = r;
      } else {
        glacialGeology.opacity = ORIGINALS.glacialOpacity;
        bedrockGeology.opacity  = ORIGINALS.bedrockOpacity;
        const poiR = poiLayer.renderer.clone(); poiR.symbol.size = ORIGINALS.poiSize; poiLayer.renderer = poiR;
        const r = sectionsTop.renderer.clone();
        r.uniqueValueInfos = r.uniqueValueInfos.map((u) => {
          const sym = u.symbol.clone();
          sym.width = (u.value === "Connecting Route") ? ORIGINALS.trailWidthCR : ORIGINALS.trailWidthIAT;
          if (u.value === "Connecting Route") sym.style = "dash";
          return { ...u, symbol: sym };
        });
        sectionsTop.renderer = r;
      }
    });

    // ----- When user clicks a trail segment, update Segments tab -----
    view.on("click", function(event){
      view.hitTest(event).then(function(response){
        const result = response.results.find(r => r.graphic && r.graphic.layer === sectionsTop);
        if (!result) return;
        const attrs = result.graphic.attributes || {};
        const segName = attrs.Segment;
        if (segName){
          updateSegmentPanel(segName);
        }
      });
    });

  }); // require
  </script>
</body>
</html>
